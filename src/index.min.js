/*
 Copyright (c) 2017, Nazar Mokrynskyi
 @license   MIT License, see license.txt
*/
(function(){function p(d){var f;for(f=d.length-1;0<=f;--f){var g=f;++d[g];if(0!==d[g])break}}function m(d,f,g,e){function h(a){!a&&(a=null);if(!(this instanceof h))return new h(a);null===a&&(a=n(48));this.b=a;this.a=new Uint8Array(12)}function k(a,b){if(!(this instanceof k))return new k(a,b);a?(this.a=e.HandshakeState(q,e.constants.NOISE_ROLE_INITIATOR),this.a.Initialize(null,null,b)):(this.a=e.HandshakeState(q,e.constants.NOISE_ROLE_RESPONDER),this.a.Initialize(null,b))}h.prototype={get_key:function(){return this.b},
wrap:function(a){p(this.a);return g.encrypt(a,new Uint8Array(0),this.a,this.b,0)},unwrap:function(a){p(this.a);return g.decrypt(a,new Uint8Array(0),this.a,this.b,0)}};Object.defineProperty(h.prototype,"constructor",{enumerable:!1,value:h});k.prototype={ready:function(){return!this.a},get_handshake_message:function(){var a=null;this.a&&(this.a.GetAction()===e.constants.NOISE_ACTION_WRITE_MESSAGE&&(a=this.a.WriteMessage()),this.f());return a},put_handshake_message:function(a){this.a&&(this.a.GetAction()===
e.constants.NOISE_ACTION_READ_MESSAGE&&this.a.ReadMessage(a),this.f())},f:function(){var a=this.a.GetAction();if(a===e.constants.NOISE_ACTION_SPLIT){a=this.a.Split();this.c=a[0];this.b=a[1];a=new Uint8Array(0);var b=new Uint8Array(32);this.h=this.c.EncryptWithAd(a,b);this.g=this.b.EncryptWithAd(a,b);delete this.a}else if(a===e.constants.NOISE_ACTION_FAILED)throw delete this.a,Error("Noise handshake failed");},get_rewrapper_keys:function(){return[this.h,this.g]},encrypt:function(a){return this.c.EncryptWithAd(new Uint8Array(0),
a)},decrypt:function(a){return this.b.DecryptWithAd(new Uint8Array(0),a)},destroy:function(){this.a&&this.a.free();this.c&&this.c.free();this.b&&this.b.free()}};Object.defineProperty(k.prototype,"constructor",{enumerable:!1,value:k});return{ready:function(a){function b(){--c;c||a()}var c=4;d.ready(b);f.ready(b);g.ready(b);e.ready(b)},create_keypair:function(a){!a&&(a=null);a||(a=d.createSeed());var b=d.createKeyPair(a);return{seed:a,ed25519:{"public":b.publicKey,"private":b.secretKey},x25519:{"public":f.convert_public_key(b.publicKey),
"private":f.convert_private_key(a)}}},convert_public_key:function(a){return f.convert_public_key(a)},sign:function(a,b,c){return d.sign(a,b,c)},verify:function(a,b,c){return d.verify(a,b,c)},Rewrapper:h,Encryptor:k,one_way_encrypt:function(a,b){var c=e.HandshakeState(r,e.constants.NOISE_ROLE_INITIATOR);c.Initialize(null,null,a);a=c.WriteMessage();var d=c.Split();c=d[0];d=d[1];b=c.EncryptWithAd(new Uint8Array(0),b);c.free();d.free();c=new Uint8Array(l+b.length);c.set(a);c.set(b,l);return c},one_way_decrypt:function(a,
b){var c=b.subarray(0,l);b=b.subarray(l);var d=e.HandshakeState(r,e.constants.NOISE_ROLE_RESPONDER);d.Initialize(null,a);d.ReadMessage(c);c=d.Split();a=c[0];c=c[1];b=c.DecryptWithAd(new Uint8Array(0),b);a.free();c.free();return b}}}var n;"object"===typeof exports?n=require("crypto").randomBytes:n=function(d){d=new Uint8Array(d);crypto.getRandomValues(d);return d};var q="Noise_NK_25519_ChaChaPoly_BLAKE2b";var r="Noise_N_25519_ChaChaPoly_BLAKE2b";var l=48;"function"===typeof define&&define.amd?define(["supercop.wasm",
"ed25519-to-x25519.wasm","aez.wasm","noise-c.wasm"],m):"object"===typeof exports?module.exports=m(require("supercop.wasm"),require("ed25519-to-x25519.wasm"),require("aez.wasm"),require("noise-c.wasm")):this.detox_crypto=m(this.supercop_wasm,this.ed25519_to_x25519_wasm,this.aez_wasm,this.noise_c_wasm)}).call(this);